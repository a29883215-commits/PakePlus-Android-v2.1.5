<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½“è‚²è¯¾æ™ºèƒ½è®¡æ—¶ç³»ç»Ÿ v2.1 (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans">

    <div id="page-home" class="flex-1 flex flex-col p-6 space-y-6">
        <div class="text-center mt-8">
            <h1 class="text-2xl font-bold text-gray-800">ğŸƒâ€â™‚ï¸ ä½“è‚²è®¡æ—¶ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="text-gray-500 text-sm mt-2">v2.1 ä¿®å¤ç‰ˆ</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm">
            <label class="block text-gray-700 font-bold mb-2">å½“å‰æµ‹è¯•ç­çº§</label>
            <select id="classSelect" class="w-full p-3 border border-gray-300 rounded-lg text-lg bg-white mb-4">
                </select>
            
            <label class="block text-gray-700 font-bold mb-2 text-sm">æ·»åŠ æ–°ç­çº§</label>
            <div class="flex gap-2">
                <input type="text" id="newClassInput" 
                       placeholder="è¾“å…¥ç­çº§ (å¦‚: åˆäºŒ5ç­)" 
                       class="flex-1 p-3 border border-gray-300 rounded-lg"
                       onkeydown="if(event.key === 'Enter') addClass()"> 
                <button onclick="addClass()" class="bg-blue-600 text-white px-6 rounded-lg font-bold text-xl active:bg-blue-700">+</button>
            </div>
        </div>

        <button onclick="goToTimer()" class="w-full py-4 bg-blue-600 text-white rounded-xl text-xl font-bold shadow-lg active:scale-95 transition-transform">
            å¼€å§‹æ–°æµ‹è¯•
        </button>

        <button onclick="goToHistory()" class="w-full py-4 bg-white text-blue-600 border border-blue-200 rounded-xl text-xl font-bold shadow-sm active:bg-blue-50">
            ğŸ“Š æŸ¥çœ‹å†å²è®°å½•
        </button>
    </div>

    <div id="page-timer" class="hidden flex-col h-full">
        <div class="bg-white shadow p-3 flex justify-between items-center z-10">
            <button onclick="goHome()" class="text-gray-500 font-bold text-sm">â† è¿”å›</button>
            <div class="font-bold text-gray-800" id="currentClassDisplay">åˆäºŒ(1)ç­</div>
            <div class="text-xs text-gray-400">æµ‹è¯•ä¸­</div>
        </div>

        <div class="bg-white pb-4 text-center">
            <div id="timerDisplay" class="text-6xl font-mono font-bold text-gray-800 tracking-wider">00:00.00</div>
            <div class="flex justify-center gap-3 mt-4 px-4">
                <button id="startBtn" onclick="toggleTimer()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">å¼€å§‹</button>
                <button onclick="resetTimerData()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg font-bold">é‡ç½®</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 mb-24 no-scrollbar" id="listContainer">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 sticky top-0">
                    <tr class="text-gray-500 text-xs uppercase">
                        <th class="p-2 text-center w-12">åæ¬¡</th>
                        <th class="p-2 w-24">æˆç»©</th>
                        <th class="p-2">å­¦å· (èµ›åå½•å…¥)</th>
                    </tr>
                </thead>
                <tbody id="recordTableBody" class="bg-white"></tbody>
            </table>
            <div id="emptyTip" class="text-center text-gray-400 mt-10 text-sm">ç‚¹å‡»å¼€å§‹å<br>æŒ‰ä¸‹æ–¹ç»¿è‰²æŒ‰é’®è®°å½•æˆç»©</div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t p-3 pb-8 flex flex-col gap-2">
            <button id="recordBtn" onclick="recordLap()" disabled class="w-full h-20 bg-gray-300 text-white rounded-2xl text-2xl font-bold shadow transition-all flex items-center justify-center gap-2">
                â±ï¸ è®°å½•å†²çº¿
            </button>
            <button onclick="saveAndFinish()" class="w-full py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold">
                ğŸ’¾ ä¿å­˜å¹¶ç»“æŸæœ¬æ¬¡æµ‹è¯•
            </button>
        </div>
    </div>

    <div id="page-history" class="hidden flex-col h-full bg-gray-50">
        <div class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-20">
            <button onclick="goHome()" class="text-gray-500 font-bold">â† è¿”å›é¦–é¡µ</button>
            <h2 class="font-bold text-lg">å†å²æ•°æ®ä¸­å¿ƒ</h2>
            <div class="w-10"></div>
        </div>

        <div class="p-4 flex-1 overflow-y-auto">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                <h3 class="font-bold text-blue-800 mb-2">ğŸ“¥ å¯¼å‡ºç­çº§æˆé•¿æ¡£æ¡ˆ</h3>
                <div class="flex gap-2">
                    <select id="exportClassSelect" class="flex-1 p-2 rounded border border-blue-200 text-sm"></select>
                    <button onclick="exportClassHistory()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold">å¯¼å‡ºExcel</button>
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-2">ğŸ“œ å†å²æµ‹è¯•è®°å½•</h3>
            <div id="historyList" class="space-y-3"></div>
            
            <div class="mt-8 text-center">
                 <button onclick="clearAllData()" class="text-red-400 text-xs underline">æ¸…ç©ºæ‰€æœ‰æ•°æ® (æ…ç”¨)</button>
            </div>
        </div>
    </div>

    <script>
        // ================= æ•°æ®ç»“æ„ =================
        let appData = {
            classes: ["åˆä¸€(1)ç­", "åˆä¸€(2)ç­"], 
            history: [] 
        };
        
        let currentSession = {
            className: "", startTime: 0, elapsedTime: 0, isRunning: false, records: [] 
        };

        let timerInterval;

        // ================= åˆå§‹åŒ– =================
        window.onload = function() {
            loadSystemData(); 
            loadSessionData(); 
            renderClassSelects();
            
            // æ¢å¤æœªå®Œæˆçš„æµ‹è¯•
            if(currentSession.startTime > 0 || currentSession.records.length > 0) {
                showPage('timer');
                document.getElementById('currentClassDisplay').innerText = currentSession.className;
                renderTable();
                updateTimerDisplay(currentSession.elapsedTime);
                if(currentSession.isRunning) toggleTimer(true);
            }
        };

        // ================= é¡µé¢åˆ‡æ¢ =================
        function showPage(pageId) {
            ['home', 'timer', 'history'].forEach(id => {
                document.getElementById('page-'+id).classList.add('hidden');
            });
            document.getElementById('page-'+pageId).classList.remove('hidden');
            if(pageId === 'history') renderHistoryList();
        }
        function goHome() { showPage('home'); }
        function goToHistory() { showPage('history'); }

        function goToTimer() {
            const select = document.getElementById('classSelect');
            if(!select.value) { alert("è¯·å…ˆæ·»åŠ æˆ–é€‰æ‹©ä¸€ä¸ªç­çº§"); return; }
            
            if(currentSession.records.length > 0 && currentSession.className !== select.value) {
                if(!confirm("å½“å‰æœ‰ä¸€ä¸ªæœªå®Œæˆçš„æµ‹è¯•ï¼Œæ˜¯å¦æ”¾å¼ƒå¹¶å¼€å§‹æ–°çš„ï¼Ÿ")) return;
                resetTimerData(true);
            }

            if(currentSession.records.length === 0) {
                currentSession.className = select.value;
                document.getElementById('currentClassDisplay').innerText = currentSession.className;
            }
            showPage('timer');
        }

        // ================= ç­çº§ç®¡ç† (ä¿®å¤é‡ç‚¹) =================
        function renderClassSelects() {
            const selects = [document.getElementById('classSelect'), document.getElementById('exportClassSelect')];
            // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šç¡®ä¿classesæ•°ç»„å­˜åœ¨
            if(!appData.classes) appData.classes = [];
            
            const html = appData.classes.map(c => `<option value="${c}">${c}</option>`).join('');
            selects.forEach(s => { if(s) s.innerHTML = html; });
        }

        function addClass() {
            const input = document.getElementById('newClassInput');
            const val = input.value.trim();
            
            if(!val) {
                alert("è¯·è¾“å…¥ç­çº§åç§°ï¼");
                return;
            }
            
            if(appData.classes.includes(val)) {
                alert("è¿™ä¸ªç­çº§å·²ç»å­˜åœ¨äº†ï¼");
                input.value = ""; // æ¸…ç©ºä»¥ä¾¿é‡è¾“
                return;
            }

            // æ‰§è¡Œæ·»åŠ 
            appData.classes.push(val);
            saveSystemData();
            renderClassSelects();
            
            // é€‰ä¸­æ–°ç­çº§å¹¶åé¦ˆ
            document.getElementById('classSelect').value = val;
            input.value = '';
            // æ”¶èµ·é”®ç›˜ (å¯é€‰)
            input.blur();
        }

        // ================= è®¡æ—¶é€»è¾‘ =================
        function toggleTimer(isResume = false) {
            if (currentSession.isRunning && !isResume) {
                clearInterval(timerInterval);
                currentSession.isRunning = false;
                updateControlUI(false);
            } else {
                if (currentSession.startTime === 0) currentSession.startTime = Date.now() - currentSession.elapsedTime;
                else currentSession.startTime = Date.now() - currentSession.elapsedTime;
                
                timerInterval = setInterval(() => {
                    currentSession.elapsedTime = Date.now() - currentSession.startTime;
                    updateTimerDisplay(currentSession.elapsedTime);
                }, 30);
                currentSession.isRunning = true;
                updateControlUI(true);
            }
            saveSessionData();
        }

        function updateControlUI(running) {
            const btn = document.getElementById('startBtn');
            const recBtn = document.getElementById('recordBtn');
            if(running) {
                btn.innerText = "æš‚åœ";
                btn.className = "flex-1 py-2 bg-yellow-500 text-white rounded-lg font-bold";
                recBtn.disabled = false;
                recBtn.className = "w-full h-20 bg-green-500 text-white rounded-2xl text-2xl font-bold shadow active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer";
            } else {
                btn.innerText = "ç»§ç»­";
                btn.className = "flex-1 py-2 bg-green-600 text-white rounded-lg font-bold";
                recBtn.disabled = true;
                recBtn.className = "w-full h-20 bg-gray-300 text-white rounded-2xl text-2xl font-bold shadow flex items-center justify-center gap-2";
            }
        }

        function updateTimerDisplay(ms) {
            document.getElementById('timerDisplay').innerText = formatTime(ms);
        }

        function formatTime(ms) {
            let date = new Date(ms);
            let m = date.getUTCMinutes().toString().padStart(2, '0');
            let s = date.getUTCSeconds().toString().padStart(2, '0');
            let msShow = Math.floor(date.getUTCMilliseconds() / 10).toString().padStart(2, '0');
            return `${m}:${s}.${msShow}`;
        }

        function recordLap() {
            if (!currentSession.isRunning) return;
            const rank = currentSession.records.length + 1;
            const timeStr = formatTime(currentSession.elapsedTime);
            
            currentSession.records.push({ rank: rank, time: timeStr, studentId: "" });
            renderRow(rank, timeStr, "");
            saveSessionData();
            
            const container = document.getElementById('listContainer');
            container.scrollTop = container.scrollHeight;
        }

        function renderTable() {
            const tbody = document.getElementById('recordTableBody');
            tbody.innerHTML = '';
            if (currentSession.records.length > 0) {
                document.getElementById('emptyTip').style.display = 'none';
                currentSession.records.forEach(rec => renderRow(rec.rank, rec.time, rec.studentId));
            } else {
                document.getElementById('emptyTip').style.display = 'block';
            }
        }

        function renderRow(rank, time, idVal) {
            const tbody = document.getElementById('recordTableBody');
            const tr = document.createElement('tr');
            tr.className = "border-b bg-white";
            tr.innerHTML = `
                <td class="p-2 text-center text-gray-500 font-bold">${rank}</td>
                <td class="p-2 font-mono font-bold text-blue-600 text-lg">${time}</td>
                <td class="p-2">
                    <input type="number" value="${idVal}" placeholder="è¾“å…¥å­¦å·" 
                        class="w-full p-2 border border-gray-200 rounded bg-gray-50 focus:bg-white focus:border-blue-500 outline-none"
                        oninput="updateStudentId(${rank - 1}, this.value)"
                        onkeydown="handleEnter(event, ${rank - 1})"
                        id="input-${rank-1}"
                    >
                </td>
            `;
            tbody.appendChild(tr);
        }

        function updateStudentId(idx, val) {
            currentSession.records[idx].studentId = val;
            saveSessionData();
        }

        function handleEnter(e, idx) {
            if(e.key === 'Enter') {
                const next = document.getElementById(`input-${idx+1}`);
                if(next) next.focus();
                else e.target.blur();
            }
        }

        function resetTimerData(force = false) {
            if (!force && !confirm("ç¡®å®šè¦é‡ç½®å½“å‰è®¡æ—¶å—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚")) return;
            clearInterval(timerInterval);
            currentSession = { className: currentSession.className, startTime: 0, elapsedTime: 0, isRunning: false, records: [] };
            updateTimerDisplay(0);
            renderTable();
            updateControlUI(false);
            document.getElementById('startBtn').innerText = "å¼€å§‹";
            document.getElementById('startBtn').className = "flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold";
            saveSessionData();
        }

        function saveAndFinish() {
            if(currentSession.records.length === 0) { alert("æ²¡æœ‰æ•°æ®å¯ä¿å­˜"); return; }
            if(!confirm("ç¡®å®šç»“æŸæœ¬æ¬¡æµ‹è¯•å¹¶ä¿å­˜åˆ°åå°å—ï¼Ÿ")) return;

            const newHistoryItem = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                className: currentSession.className,
                records: JSON.parse(JSON.stringify(currentSession.records))
            };
            
            appData.history.unshift(newHistoryItem); 
            saveSystemData();

            clearInterval(timerInterval);
            currentSession = { className: "", startTime: 0, elapsedTime: 0, isRunning: false, records: [] };
            saveSessionData();

            alert("ä¿å­˜æˆåŠŸï¼");
            goHome();
        }

        // ================= å†å²ä¸å¯¼å‡º =================
        function renderHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            if(!appData.history || appData.history.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-4">æš‚æ— å†å²è®°å½•</div>`;
                return;
            }

            appData.history.forEach(item => {
                const count = item.records.length;
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-lg text-gray-800">${item.className}</div>
                            <div class="text-xs text-gray-400">${item.date}</div>
                        </div>
                        <div class="text-right">
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${count}äººå‚åŠ </span>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="exportOneTest(${item.id})" class="flex-1 py-1 text-xs border border-green-200 text-green-700 bg-green-50 rounded">å¯¼å‡ºæœ¬æ¬¡CSV</button>
                        <button onclick="deleteHistory(${item.id})" class="px-3 py-1 text-xs border border-red-100 text-red-400 bg-red-50 rounded">åˆ é™¤</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function deleteHistory(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
            appData.history = appData.history.filter(i => i.id !== id);
            saveSystemData();
            renderHistoryList();
        }

        function clearAllData() {
            if(prompt("è¯·è¾“å…¥ 'DELETE' ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼š") === 'DELETE') {
                localStorage.clear();
                location.reload();
            }
        }

        function exportOneTest(id) {
            const item = appData.history.find(i => i.id === id);
            if(!item) return;
            let csv = "\uFEFFåæ¬¡,æˆç»©,å­¦å·\n";
            item.records.forEach(r => csv += `${r.rank},${r.time},"${r.studentId}"\n`);
            downloadCSV(csv, `${item.className}_${item.date}.csv`);
        }

        function exportClassHistory() {
            const className = document.getElementById('exportClassSelect').value;
            if(!className) return;
            
            const classHistory = appData.history
                .filter(h => h.className === className)
                .sort((a, b) => a.id - b.id);

            if(classHistory.length === 0) { alert("è¯¥ç­çº§æš‚æ— å†å²æ•°æ®"); return; }

            const allStudentIds = new Set();
            classHistory.forEach(h => {
                h.records.forEach(r => { if(r.studentId) allStudentIds.add(r.studentId); });
            });
            
            // å­¦å·ç®€å•æ’åºï¼šå°è¯•æŒ‰æ•°å­—æ’ï¼Œå¦‚æœä¸æ˜¯çº¯æ•°å­—åˆ™æŒ‰å­—ç¬¦æ’
            const sortedIds = Array.from(allStudentIds).sort((a,b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });

            let csv = "\uFEFFå­¦å·";
            classHistory.forEach(h => {
                const d = new Date(h.id);
                csv += `,${d.getMonth()+1}/${d.getDate()}`;
            });
            csv += "\n";

            sortedIds.forEach(sid => {
                let row = `"${sid}"`;
                classHistory.forEach(h => {
                    const record = h.records.find(r => r.studentId == sid);
                    row += `,${record ? record.time : "-"}`;
                });
                csv += row + "\n";
            });

            downloadCSV(csv, `${className}_å†å²æˆé•¿æ¡£æ¡ˆ.csv`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================= å­˜å‚¨åº•å±‚ (ä¿®å¤é‡ç‚¹) =================
        function saveSystemData() {
            localStorage.setItem('pe_timer_data_v2', JSON.stringify(appData));
        }
        function loadSystemData() {
            try {
                const d = localStorage.getItem('pe_timer_data_v2');
                if(d) {
                    appData = JSON.parse(d);
                    // ä¿®å¤æ—§æ•°æ®å¯èƒ½ç¼ºå°‘å­—æ®µçš„é—®é¢˜
                    if(!appData.classes) appData.classes = ["åˆä¸€(1)ç­", "åˆä¸€(2)ç­"];
                    if(!appData.history) appData.history = [];
                }
            } catch(e) {
                console.error("æ•°æ®åŠ è½½é”™è¯¯ï¼Œå·²é‡ç½®", e);
                // ä¿æŒé»˜è®¤å€¼
            }
        }
        function saveSessionData() {
            localStorage.setItem('pe_timer_session', JSON.stringify(currentSession));
        }
        function loadSessionData() {
            try {
                const s = localStorage.getItem('pe_timer_session');
                if(s) currentSession = JSON.parse(s);
            } catch(e) {}
        }
    </script>
</body>
</html>